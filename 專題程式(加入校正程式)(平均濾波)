import cv2
import numpy as np
import matplotlib.pyplot as plt
import time
from collections import deque
from datetime import datetime

PIXEL_TO_MM = 0.264  # é è¨­å€¼

diameters = deque(maxlen=100)
times = deque(maxlen=100)

def auto_calibrate():
    global PIXEL_TO_MM
    known_diameter_mm = float(input("è«‹è¼¸å…¥æ¨™æº–åœ“çš„ç›´å¾‘ (mm): "))

    cap = cv2.VideoCapture(0)
    if not cap.isOpened():
        print("âŒ ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿ")
        return False

    print("ğŸ” å°‡æ¨™æº–åœ“æ”¾åœ¨ç•«é¢ä¸­å¤®ï¼ŒæŒ‰ '1' æ ¡æ­£")

    while True:
        ret, frame = cap.read()
        if not ret:
            print("âŒ ç„¡æ³•ç²å–å½±åƒ")
            break

        cv2.imshow("Calibration", frame)
        key = cv2.waitKey(1) & 0xFF
        if key == ord('1'):
            gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
            circles = cv2.HoughCircles(gray, cv2.HOUGH_GRADIENT, 1, 50, param1=100, param2=30, minRadius=10, maxRadius=300)
            if circles is not None:
                circles = np.uint16(np.around(circles))
                max_diameter = max(i[2] * 2 for i in circles[0])
                PIXEL_TO_MM = known_diameter_mm / max_diameter
                print(f"âœ… æ ¡æ­£å®Œæˆ: 1 åƒç´  = {PIXEL_TO_MM:.5f} mm")
            break
    cap.release()
    cv2.destroyAllWindows()

def detect_circles():
    cap = cv2.VideoCapture(0)
    if not cap.isOpened():
        print("âŒ ç„¡æ³•é–‹å•Ÿæ”å½±æ©Ÿ")
        return

    print("ğŸ¯ åµæ¸¬åœ“å½¢ï¼ŒæŒ‰ 'Q' é€€å‡º")

    while True:
        ret, frame = cap.read()
        if not ret:
            print("âŒ ç„¡æ³•ç²å–å½±åƒ")
            break

        gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
        circles = cv2.HoughCircles(gray, cv2.HOUGH_GRADIENT, 1, 50, param1=100, param2=30, minRadius=10, maxRadius=300)

        if circles is not None:
            circles = np.uint16(np.around(circles))
            max_diameter = max(i[2] * 2 for i in circles[0])
            max_diameter_mm = max_diameter * PIXEL_TO_MM
            print(f"ğŸ“ æœ€å¤§åœ“ç›´å¾‘: {max_diameter_mm:.2f} mm")

            times.append(time.strftime("%H:%M:%S"))
            diameters.append(max_diameter_mm)

            for i in circles[0]:
                cv2.circle(frame, (i[0], i[1]), i[2], (255, 0, 255), 2)

        cv2.imshow("Detected Circles", frame)
        key = cv2.waitKey(1) & 0xFF
        if key == ord('q'):
            break

    cap.release()
    cv2.destroyAllWindows()

    # å„²å­˜ä¸¦é¡¯ç¤ºè¶¨å‹¢åœ–
    plt.plot(times, diameters, color='red', label="Max Diameter")
    plt.xlabel("Time")
    plt.ylabel("Diameter (mm)")
    plt.legend()
    plt.savefig("trend.png")
    print("ğŸ“Š åœ–è¡¨å·²å„²å­˜ç‚º trend.pngï¼Œè«‹æ‰‹å‹•æŸ¥çœ‹")

# åŸ·è¡Œç¨‹å¼
if __name__ == "__main__":
    print("ğŸ”„ æŒ‰ '1' é€²è¡Œæ ¡æ­£ï¼Œæ ¡æ­£å¾Œé€²è¡Œåœ“å½¢åµæ¸¬")

    while True:
        key = input("è¼¸å…¥ 1 é–‹å§‹æ ¡æ­£ï¼Œq é€€å‡º: ")
        if key == "1":
            if auto_calibrate():
                detect_circles()
            break
        elif key == "q":
            break